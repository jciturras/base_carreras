# Pool de carreras/instituciones

# Esta es la base a la que hay que pegarle la información de las carreras. 
# Ver pool de carreras/instituciones

library(dplyr)
library(stringr)
library(tidyr)
library(data.table)
library(here)
rm(list=ls())

# Base de datos postulaciones 2016
# Esta es la base a la que hay que pegarle la información de las carreras
postula <- fread(here("data","PSUAlumn","C_POSTULACIONES_SELECCION_PSU_2016_PRIV_MRUN.csv"))
postula <- postula %>% select(6,7,9) %>% distinct() %>% arrange(NOMBRE_CARRERA,SIGLA_UNIVERSIDAD)

# Pegar a oferta CODIGO_CARRERA=DEMRE
oferta <- readxl::read_excel(here("output","oferta2016_filtrada_carrera_ind_inst.xlsx")) 
oferta <- oferta %>% select(-X__1)

data <- left_join(postula,oferta,by=c("CODIGO_CARRERA"="DEMRE")) %>% group_by(CODIGO_CARRERA) %>% mutate(n = n(),c=row_number()) %>% ungroup()

data <- data %>% select("CODIGO_CARRERA","NOMBRE_CARRERA.x","NOMBRE_CARRERA.y",
                        "AREA_CONOCIMIENTO","OECD_AREA","OECD_SUBAREA","AREA_CARRERA_GENERICA",
                        "TIPO_IES","CODIGO_IES","SIGLA_UNIVERSIDAD","NOMBRE_IES",
                        "MATRICULA_ANUAL","COSTO_TITULACION","COSTO_CERTIFICADO_DIPLOMA","ARANCEL_ANUAL",
                        "ID_CARRERA","PUNTAJE_CORTE") %>% distinct() %>% group_by(CODIGO_CARRERA) %>% mutate(n = n(),c=row_number()) %>% ungroup()





# Errores de codigo: Varias carreras aparecen corridas. Manda el nombre de la carrera en 
# postulaciones y la sigla de la carrera
# 
# postula %>% filter(CODIGO_CARRERA %in% c(37058,37090,40072,25053,26066))
# data %>% filter(CODIGO_CARRERA %in% c(37058,37090,40072,25053,26066))

# Duplicados. 

# data %>% filter(n>1) %>%  as.data.frame()

# En postulaciones hay 1 codigo pero en oferta corresponde a mas de una carrera
# Cuando hay diferencias de nombre, se deja el nombre de la carrera de postulaciones
data <- data %>% filter(!(CODIGO_CARRERA==37092 & c==1), 
                        !(CODIGO_CARRERA==14004 & c==1),
                        !(CODIGO_CARRERA==37069 & c==2),
                        !(CODIGO_CARRERA==42002 & c!=4),
                        !(CODIGO_CARRERA==42022 & c!=4),
                        !(CODIGO_CARRERA==40071 & c==2))

# Revisar 43006 (no importa si se filtran los bachilleratos) y 43011. Agregar si es necesario.




# Perdidos.
# Llenar informacion para los casos que estan en postulacion pero no estan en oferta
datana <-data %>% filter(is.na(CODIGO_IES))

datana <- datana %>%
  mutate(
    NOMBRE_CARRERA.y=case_when(
      CODIGO_CARRERA==23025	~	"ARQUITECTURA",
      CODIGO_CARRERA==37090	~	"BACHILLERATO EN CIENCIAS Y HUMANIDADES",
      CODIGO_CARRERA==37058	~	"INGENIERIA CIVIL GEOLOGICA",
      CODIGO_CARRERA==40072	~	"NUTRICION Y DIETETICA",
      CODIGO_CARRERA==26066	~	"PEDAGOGIA EN FISICA",
      CODIGO_CARRERA==25053	~	"PEDAGOGIA EN EDUCACION GENERAL BASICA",
      TRUE ~ NA_character_),
    AREA_CONOCIMIENTO=case_when(
      CODIGO_CARRERA==23025	~	"Arte y Arquitectura",
      CODIGO_CARRERA==37090	~	"Ciencias Básicas",
      CODIGO_CARRERA==37058	~	"Tecnología",
      CODIGO_CARRERA==40072	~	"Salud",
      CODIGO_CARRERA==26066	~	"Educación",
      CODIGO_CARRERA==25053	~	"Educación",
      TRUE ~ NA_character_),
    OECD_AREA=case_when(
      CODIGO_CARRERA==23025	~	"Ingeniería, Industria y Construcción",
      CODIGO_CARRERA==37090	~	"Ciencias",
      CODIGO_CARRERA==37058	~	"Ingeniería, Industria y Construcción",
      CODIGO_CARRERA==40072	~	"Salud y Servicios Sociales",
      CODIGO_CARRERA==26066	~	"Educación",
      CODIGO_CARRERA==25053	~	"Educación",TRUE ~ NA_character_),
    OECD_SUBAREA=case_when(
      CODIGO_CARRERA==23025	~	"Arquitectura y Construcción",
      CODIGO_CARRERA==37090	~	"Ciencias Físicas",
      CODIGO_CARRERA==37058	~	"Ingeniería y Profesiones Afines",
      CODIGO_CARRERA==40072	~	"Medicina",
      CODIGO_CARRERA==26066	~	"Formación de Personal Docente",
      CODIGO_CARRERA==25053	~	"Formación de Personal Docente",
      TRUE ~ NA_character_),
    AREA_CARRERA_GENERICA=case_when(
      CODIGO_CARRERA==23025	~	"Arquitectura",
      CODIGO_CARRERA==37090	~	"Bachillerato y/o Licenciatura en Ciencias",
      CODIGO_CARRERA==37058	~	"Otras Ingenierías Civiles",
      CODIGO_CARRERA==40072	~	"Nutrición y Dietética",
      CODIGO_CARRERA==26066	~	"Pedagogía en Ciencias",
      CODIGO_CARRERA==25053	~	"Pedagogía en Educación Básica",
      TRUE ~ NA_character_),
    TIPO_IES=case_when(
      CODIGO_CARRERA==23025	~	"A",
      CODIGO_CARRERA==37090	~	"B",
      CODIGO_CARRERA==37058	~	"B",
      CODIGO_CARRERA==40072	~	"C",
      CODIGO_CARRERA==26066	~	"A",
      CODIGO_CARRERA==25053	~	"A",
      TRUE ~ NA_character_),
    CODIGO_IES=case_when(
      CODIGO_CARRERA==23025	~	81,
      CODIGO_CARRERA==37090	~	94,
      CODIGO_CARRERA==37058	~	94,
      CODIGO_CARRERA==40072	~	2,
      CODIGO_CARRERA==26066	~	83,
      CODIGO_CARRERA==25053	~	74,
      TRUE ~ NA_real_),
    NOMBRE_IES=case_when(
      CODIGO_CARRERA==23025	~	"UNIVERSIDAD ARTURO PRAT",
      CODIGO_CARRERA==37090	~	"UNIVERSIDAD CATOLICA DE TEMUCO",
      CODIGO_CARRERA==37058	~	"UNIVERSIDAD CATOLICA DE TEMUCO",
      CODIGO_CARRERA==40072	~	"UNIVERSIDAD FINIS TERRAE",
      CODIGO_CARRERA==26066	~	"UNIVERSIDAD DE PLAYA ANCHA DE CIENCIAS DE LA EDUCACION",
      CODIGO_CARRERA==25053	~	"UNIVERSIDAD DE LA SERENA",
      TRUE ~ NA_character_),
    MATRICULA_ANUAL=case_when(
      CODIGO_CARRERA==23025	~	135000,
      CODIGO_CARRERA==37090	~	136500,
      CODIGO_CARRERA==37058	~	136500,
      CODIGO_CARRERA==40072	~	NA_real_,
      CODIGO_CARRERA==26066	~	140000,
      CODIGO_CARRERA==25053	~	145500,
      TRUE ~ NA_real_),
    COSTO_TITULACION=case_when(
      CODIGO_CARRERA==23025	~	247000,
      CODIGO_CARRERA==37090	~	89702,
      CODIGO_CARRERA==37058	~	89702,
      CODIGO_CARRERA==40072	~	NA_real_,
      CODIGO_CARRERA==26066	~	156600,
      CODIGO_CARRERA==25053	~	163600,
      TRUE ~ NA_real_),
    ARANCEL_ANUAL=case_when(
      CODIGO_CARRERA==23025	~	2472375,
      CODIGO_CARRERA==37090	~	1594000,
      CODIGO_CARRERA==37058	~	3194000,
      CODIGO_CARRERA==40072	~	3802000,
      CODIGO_CARRERA==26066	~	1934600,
      CODIGO_CARRERA==25053	~	1782000,
      TRUE ~ NA_real_),
    PUNTAJE_CORTE=case_when(
      CODIGO_CARRERA==23025	~	0,
      CODIGO_CARRERA==37090	~	0,
      CODIGO_CARRERA==37058	~	0,
      CODIGO_CARRERA==40072	~	NA_real_,
      CODIGO_CARRERA==26066	~	500,
      CODIGO_CARRERA==25053	~	500,
      TRUE ~ NA_real_))

data <-data %>% filter(!is.na(CODIGO_IES))

data <- data %>% bind_rows(., datana)



# Pegar datos empleabilidad e ingreso
incemp <- readxl::read_excel(here("output","empleabilidad_ingreso_carrera.xlsx"))
incemp <- incemp %>% filter(!is.na(ID)) %>% select(2:60) %>% distinct() %>% filter(`Tipo de institución`=="Universidades")


head <- c("NCG","emp18","emp1819",
          "est18","est1819","ID",
          "Area","Tipo_institucion","IPB_1anio",
          "IPB_2anio","IPB_3anio","IPB_4anio",
          "IPB_5anio","TIB_10p_inf_1anio","TIB_25p_inf_1anio",
          "TIB_50p_1anio","TIB_25p_sup_1anio","TIB_10p_sup_1anio",
          "TIB_10p_inf_5anio","TIB_25p_inf_5anio","TIB_50p_5anio",
          "TIB_25p_sup_5anio","TIB_10p_sup_5anio","EMP_1anio",
          "EMP_2anio","EIB_1anio","EIB_2anio",
          "EIB_3anio","EIB_4anio","EIB_5anio",
          "EIB_6anio","EIB_7anio","EIB_8anio",
          "EIB_9anio","EIB_10anio","TIT_Femenino",
          "TIT_Masculino","TIT_Total","DUR_Formal",
          "DUR_Real","MAT1_1anio_Femenina","MAT1_1anio_Masculina",
          "MAT1_1anio_Total","MATT_Total_Femenina","MATT_Total_Masculina",
          "MATT_Total","RET_1anio","RET_2anio",
          "RAR_menos05","RAR_05_a_099","RAR_10_a_149",
          "RAR_15_a_199","RAR_20_a_249","RAR_25_a_299",
          "RAR_mas3","DEO_Municipal","DEO_Subvencionado",
          "DEO_Particular_Pagado","DEO_Administracion_Delegada")

names(incemp) <- head

car_incemp <- left_join(data,incemp,by=c("AREA_CARRERA_GENERICA"="NCG"))

# Revisar perdidos 
xlsx::write.xlsx(car_incemp, file = "output/car_incemp.xlsx")
# car_incemp %>% filter(is.na(ID)) %>% select(1:4,7,11,18) %>% arrange(AREA_CARRERA_GENERICA)


# Cambios area carrera generica. Imputacion caso a caso.
data2 <- data %>% mutate(AREA_CARRERA_GENERICA_2=AREA_CARRERA_GENERICA)


data2 <- data2 %>% mutate(AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==21015,"Administración de Empresas e Ing. Asociadas",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==40043,"Administración Turística y Hotelera",AREA_CARRERA_GENERICA_2),AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(45036,37091),"Antropología",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==11004,"Artes y Licenciatura en Artes",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==14080,"Biología Marina y Ecología Marina",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(12011,13014,11029,11032,19075,41007,30068,39104,24062),"Bioquímica",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==16057,"Ciencias Políticas",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==39102,"Diseño Gráfico",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==15445,"Diseño Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==21087,"Ingeniería Civil Ambiental",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(30074,15161,29028,34038),"Ingeniería Civil Electrónica",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(34030,13064),"Ingeniería Civil en Computación e Informática",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==29024,"Ingeniería Civil Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==13063,"Ingeniería Civil Metalúrgica",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(13009,16002,24064,17030,13003,30078,15301,15101,15220,13066,13062,19076,36063,19081,37058,33061),"Ingeniería Civil, plan común y licenciatura en Ciencias de la Ingeniería",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==13010,"Ingeniería en Alimentos",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(41137,41140),"Ingeniería en Computación e Informática",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(41011,16042),"Ingeniería en Matemática y Estadística",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==41051,"Ingeniería en Transporte y Tránsito",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==15181,"Ingeniería Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==17040,"Ingeniería Marina y Marítimo Portuaria",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==16021,"Ingeniería Mecánica",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(12030,43026,11061,36055,41038,45010,43027,12035,38164,40020,22066,11063,45017,36061,13059,41039,41084,16058,18082,36054,12015),"Licenciatura en Letras y Literatura",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(12032,13055,13046,12031,11033,13056,19078,25027,25028,41012,15102,41013,18064),"Matemáticas y/o Estadísticas",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==40053,"Orientación Familiar y Relaciones Humanas",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==17816,"Pedagogía en Ciencias",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(16097,16096,26095),"Pedagogía en Educación Física",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(14013,21083),"Química, Licenciado en Química",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==16081,"Técnico en Alimentos",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(16089,37088,15436),"Técnico en Computación e Informática",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(16082,15446,37087),"Técnico en Construcción y Obras Civiles",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==26038,"Técnico en Dibujo Técnico e Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==27045,"Técnico en Electricidad y Electricidad Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==15538,"Técnico en Electrónica y Electrónica Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA %in% c(16085,16083),"Técnico en Instrumentación, Automatización y Control Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==16086,"Técnico en Mantenimiento Industrial",AREA_CARRERA_GENERICA_2),
                          AREA_CARRERA_GENERICA_2=ifelse(CODIGO_CARRERA==22063,"Traducción e Interpretación",AREA_CARRERA_GENERICA_2))
  
# data2 %>% select(CODIGO_CARRERA,NOMBRE_CARRERA.x,AREA_CARRERA_GENERICA,AREA_CARRERA_GENERICA_2) %>% filter(CODIGO_CARRERA %in% c(43031,11078,14009,29015,29068,41063,41004,41100,41128,16030,17813,24060,37090,44009,30065,38032,24091,44042,43007,24081,45014,44010,13052,41033,43006,24067,21046,17812,17807,43003,37086,37084,12027,12028,15221,27045,15552,15452,21015,40043,45036,37091,11004,14080,12011,13014,11029,11032,19075,41007,16057,39102,15445,21087,30074,15161,29028,34038,34030,13064,29024,13063,13009,16002,24064,17030,13003,30078,15301,15101,15220,13066,13062,19076,36063,19081,37058,33061,13010,30068,39104,24062,41137,41140,41011,16042,41051,15181,17040,16021,12030,43026,11061,36055,41038,45010,43027,12035,38164,40020,22066,11063,45017,36061,13059,41039,41084,16058,18082,36054,12015,12032,13055,13046,12031,11033,13056,19078,25027,25028,41012,15102,41013,18064,40053,17816,16097,16096,26095,14013,21083,16081,16089,37088,15436,16082,15446,37087,26038,15538,16085,16083,16086,22063)) %>% filter(AREA_CARRERA_GENERICA_2!=AREA_CARRERA_GENERICA)
  
# * INGENIERIA EN ADMINISTRACION AGROINDUSTRIAL pasa de Ingeniería Agroindustrial	a Administración de Empresas e Ing. Asociadas
# * LICENCIATURA EN DIRECCION Y GESTION DE ARTES CULIN pasa de Administración Gastronómica	a Administración Turística y Hotelera
# * ARQUEOLOGÍA pasa de Arqueología	a Antropología
# * DISEÑO TEATRAL, LICENCIATURA EN ARTES MEN/ pasa de Diseño Teatral a	Artes y Licenciatura en Artes
# * OCEANOGRAFIA pasa de Otros Profesionales de Ciencias Básicas	a Biología Marina y Ecología Marina
# * BIOLOGIA y BIOTECNOLOGIA pasan a Bioquímica
# * LICENCIATURA EN ESTUDIOS INTERNACIONALES pasa de Otros Profesionales de Ciencias Sociales a Ciencias Políticas
# * ANIMACIÓN DIGITAL pasa de Animación Digital	a Diseño Gráfico
# * TECNICO UNIVERSITARIO EN PROYECTO Y DISEÑO MECANICO pasa de Técnico en Proyecto y Diseño Mecánico	a Diseño Industrial
# * INGENIERIA CIVIL EN PREVENCION DE RIESGOS Y MEDIO AMBIENTE pasa de Otras Ingenierías Civiles a Ingeniería Civil Ambiental
# * INGENIERIA CIVIL TELEMATICA, INGENIERIA CIVIL EN AUTOMATIZACION e INGENIERÍA CIVIL MECATRÓNICA pasa a Ingeniería Civil Electrónica
# * INGENIERÍA CIVIL EN BIOINFORMÁTICA e INGENIERIA CIVIL EN TELECOMUNICACIONES pasa a Ingeniería Civil en Computación e Informática
# * INGENIERIA CIVIL EN INDUSTRIAS DE LA MADERA pasa de Ingeniería Civil en Industrias Forestales	a Ingeniería Civil Industrial
# * INGENIERIA CIVIL DE MATERIALES pasa de Ingeniería Civil en Materiales a	Ingeniería Civil Metalúrgica
# * INGENIERÍAS CIVILES que no son homologables pasan a Ingeniería Civil, plan común y licenciatura en Ciencias de la Ingeniería
# * INGENIERIA AGROINDUSTRIAL (CHILLAN) pasa de Ingeniería Agroindustrial a	Ingeniería en Alimentos
# * INGENIERIA EN TELECOMUNICACIONES e INGENIERIA BIOINFORMATICA pasan a Ingeniería en Computación e Informática
# * INGENIERIA FISICA pasa a Ingeniería en Matemática y Estadística
# * INGENIERIA EN LOGISTICA Y TRANSPORTE pasa a Ingeniería en Transporte y Tránsito
# * INGENIERIA EN DISEÑO DE PRODUCTOS pasa a Ingeniería Industrial
# * INGENIERIA NAVAL, LICENCIATURA EN CIENCIAS DE LA I pasa a Ingeniería Marina y Marítimo Portuaria
# * ING. DE EJEC. EN CLIMATIZACION (CALEFACC. REFRIG. pasa a Ingeniería Mecánica
# * Humanidades varias pasan a Licenciatura en Letras y Literatura
# * FISICA Y ASTRONOMIA pasan a Matemáticas y/o Estadísticas
# * CIENCIAS DE LA FAMILIA pasa a Orientación Familiar y Relaciones Humanas
# * LIC EN CIENCIAS C/M BIO, FIS, QUI O MAT, PED C/MEN pasa a Pedagogía en Ciencias
# * CIENCIAS DE LA ACTIVIDAD FÍSICA, DEPORTES, ENTRENAMIENTO, RECREACION pasa a Pedagogía en Educación Física
# * QUIMICA INDUSTRIAL pasa a Química, Licenciado en Química
# * TECNOLOGO EN ALIMENTOS pasa a Técnico en Alimentos
# * TECNOLOGO EN TELECOMUNICACIONES, TÉCNICO UNIVERSITARIO EN REDES Y TELECOMUNICACIONE, TECNICO UNIVERSITARIO EN TELECOMUNICACIONES Y REDE  pasa a Técnico en Computación e Informática
# * TECNOLOGO EN CONSTRUCCIONES, TECNICO UNIVERSITARIO EN PROYECTOS DE INGENIERIA, TÉCNICO UNIVERSITARIO EN TOPOGRAFÍA Y GEOMENSURA  pasa a Técnico en Construcción y Obras Civiles
# * DIBUJANTE PROYECTISTA  pasa a Técnico en Dibujo Técnico e Industrial
# * TECNICO UNIVERSITARIO EN ENERGIAS RENOVABLES Y EFI pasa a Técnico en Electricidad y Electricidad Industrial
# * TECNICO UNIVERSITARIO EN ROBOTICA Y MECATRONICA  pasa a Técnico en Electrónica y Electrónica Industrial
# * TECNOLOGO EN AUTOMATIZACION INDUSTRIAL, TECNOLOGO EN CONTROL INDUSTRIAL pasa a Técnico en Instrumentación, Automatización y Control Industrial
# * TECNOLOGO EN MANTENIMIENTO INDUSTRIAL pasa a Técnico en Mantenimiento Industrial
# * LICENCIATURA EN INGLÉS CONDUCENTE A pasa a Traducción e Interpretación
  

# Volver a mergear leer
incemp <- readxl::read_excel(here("output","empleabilidad_ingreso_carrera.xlsx"))
incemp <- incemp %>% filter(!is.na(ID)) %>% select(2:60) %>% distinct() %>% filter(`Tipo de institución`=="Universidades" |
                                                                                     (`Tipo de institución`=="Centros de Formación Técnica" &
                                                                                        (NCG %in% c("Técnico en Acuicultura y Pesca",
                                                                                                    "Técnico en Turismo y Hotelería"))))
names(incemp) <- head
car_incemp <- left_join(data2,incemp,by=c("AREA_CARRERA_GENERICA_2"="NCG"))

car_incemp %>% filter(is.na(ID)) %>% select(1:4,7,20,11,18) %>% arrange(AREA_CARRERA_GENERICA_2)


# car_incemp %>% filter(ARANCEL_ANUAL==0 | is.na(ARANCEL_ANUAL)) %>% select(CODIGO_CARRERA,NOMBRE_CARRERA.x,NOMBRE_IES,ARANCEL_ANUAL)

# No hay dato para 24088. Se promedia el arancel 2015 con el 2017
car_incemp <- car_incemp %>% mutate(ARANCEL_ANUAL=ifelse(CODIGO_CARRERA==24088,2643500,ARANCEL_ANUAL))

base_ingresos <- car_incemp %>% select(1,2,4:7,20,8:11,15,17,28:44,55:67) %>% rename(NOMBRE_CARRERA=NOMBRE_CARRERA.x)

# Generar área del conocimiento
base_ingresos <- base_ingresos %>%
  mutate(FOS=case_when(CODIGO_CARRERA	%in%	c(12024,12025,12041,12042,12043,12044,12096,12097,13027,13028,13032,13035,13036,13037,13038,13039,13040,13041,13042,13045,13057,13079,13089,13092,13098,13101,13102,14011,14014,14016,14031,14032,14033,14034,14035,14036,14037,14039,14041,14076,16043,16049,16050,16051,16052,16053,16056,16094,16095,17065,17074,17077,17084,17085,17808,17811,17823,17824,18066,18073,18075,18085,19010,19011,19024,19037,20007,20011,20012,20022,20023,20024,20025,20050,20051,20052,20054,20056,20057,20061,20066,20068,20071,20076,20081,20086,20091,20096,22025,22037,22041,22059,22061,22063,22064,22065,22090,23010,23029,23052,23054,23069,23073,24002,24041,24051,24052,24053,24054,24055,24081,25021,25024,25025,25026,25041,25042,25043,25044,25050,25051,25052,25053,26000,26004,26005,26006,26007,26008,26009,26010,26025,26030,26034,26040,26042,26043,26045,26047,26050,26053,26055,26058,26059,26060,26066,26070,26072,26073,26095,26098,27021,27023,27027,27028,29071,29072,29073,29076,29078,29080,29082,29083,29086,30044,30047,30055,30056,30058,30060,32034,32037,32039,32040,32042,32043,32044,32045,32048,32051,33031,33032,33033,33079,33081,33082,33083,33084,35011,35013,35015,35016,35017,35018,35019,35020,35021,35023,36009,36010,36015,36052,36053,36056,36057,36065,36066,37022,37023,37024,37026,37027,37029,37045,37046,37047,37048,37082,37083,38167,38168,38326,39123,39124,39125,39126,39127,39130,40050,40051,41034,41035,41037,41041,41042,41080,41081,41082,41086,41087,41112,41113,41116,41117,43020,43021,43022,43023,44011,44012,45008,45016,45019,45020,45021,45025,45029,45030,45035) ~ "Educacion",
                       CODIGO_CARRERA	%in%	c(11003,11004,11005,11011,11016,11017,11018,11061,11063,11065,11072,11090,12005,12006,12007,12008,12009,12015,12016,12026,12030,12035,12059,13052,13054,13058,13059,14003,14004,14038,16054,16058,16066,18082,19013,19022,19028,21002,21024,22066,22067,23071,24084,25046,25063,25066,26029,26032,26039,26097,27029,29064,34062,34067,36054,36055,36061,37005,37035,37052,37090,38013,38015,38164,38166,38285,39102,39105,39108,39131,40002,40010,40020,40021,40053,40090,41002,41003,41018,41020,41033,41036,41038,41039,41040,41062,41079,41083,41084,41085,41115,41138,41139,42006,43006,43026,43027,43028,44002,44003,44005,44007,44010,44027,45010,45011,45014,45017,45018,45034) ~ "Humanidades y Artes",
                       CODIGO_CARRERA	%in%	c(11060,11062,11068,11069,11070,12017,12019,12022,12028,12034,12037,12046,13018,13023,13026,13031,13067,13077,14007,14018,14040,16030,16055,16057,16060,17029,17056,17088,17814,18039,18061,19012,19045,19064,22020,22023,22094,23015,23061,23070,25064,25065,26054,26080,26082,26096,27040,29067,30064,30091,30092,32014,33078,34041,34057,35004,35055,36011,36062,36071,36072,37001,37041,37042,37049,37061,38005,38009,38032,38162,38163,39128,39129,39419,40022,41015,41016,41019,41068,41069,41104,42004,42005,42024,42025,43005,43011,43025,44004,44013,44023,44025,44030,44037,45002,45005,45006,45024,45028,45031,45033,45036) ~ "Ciencias sociales",
                       CODIGO_CARRERA	%in%	c(11029,11030,11032,11039,12010,12011,12012,12027,13012,13013,13014,13016,13020,13048,13085,13093,14009,14012,14080,16010,16041,17001,17002,17075,17813,17816,18080,19075,19076,19080,19081,19082,21073,23007,23027,23056,24058,24060,24062,24083,29015,29069,30002,30068,30069,30073,30079,30090,32017,32026,33036,35033,36002,36060,37050,37058,37086,39104,41004,41005,41006,41007,41022,41058,41063,41064,41097,41100,41128,41148,43004) ~ "Ciencias de la vida",
                       CODIGO_CARRERA	%in%	c(11027,11031,11045,12038,12039,13003,13021,13043,13044,13061,13062,13063,13064,13066,13068,13069,13070,13071,13072,13074,13075,13076,13084,14060,14061,14062,14063,14065,14066,14067,14068,14069,14070,14071,14072,14073,14078,14081,14083,15002,15003,15004,15005,15006,15007,15009,15010,15011,15024,15025,15026,15027,15031,15032,15033,15034,15035,15036,15037,15038,15039,15042,15043,15045,15046,15047,15048,15049,15052,15055,15056,15059,15060,15061,15064,15066,15067,15068,15071,15074,15076,15077,15078,15079,15080,15090,15091,15092,16001,16002,16003,16005,16006,16007,16008,16009,16011,16012,16013,16015,16016,16017,16019,16021,16022,16067,16081,16082,16083,16084,16085,16086,16089,17004,17030,17036,17037,17040,17052,17079,17807,17812,17815,17822,18041,18055,18058,18062,18065,18067,18069,18070,18071,18072,18076,18081,18086,18093,18094,19021,19026,19052,19074,19094,21004,21023,21025,21031,21032,21037,21038,21039,21042,21045,21046,21071,21074,21075,21076,21080,22008,22028,22049,22071,22072,22077,22078,22079,22088,22101,23012,23024,23058,23062,23074,23075,23076,24064,24068,24070,24071,24072,24073,24074,24075,24076,24078,24079,24082,25001,25002,25003,25004,25005,25010,25012,25013,25014,26038,26062,26063,26064,27001,27003,27005,27030,27031,27032,27034,27037,27038,27039,27060,27061,27062,29004,29005,29019,29020,29021,29024,29026,29028,29029,29030,29032,29035,29051,30007,30012,30074,30075,30076,30077,30078,30080,30096,32018,32020,32023,32025,33005,33061,33070,34006,34009,34019,34064,34065,34066,34068,35041,36029,36030,36059,36063,36067,36068,36069,36070,36076,37012,37013,37019,37051,37053,37054,37056,37080,38080,38174,38175,38176,38292,39106,39111,39113,39402,39408,40042,40060,40061,41024,41025,41044,41046,41047,41049,41050,41051,41053,41054,41055,41074,41089,41091,41092,41093,41119,41121,41130,41131,41134,41135,41137,41140,41153,41160,41161,42002,42022,43003,43013,44014,44015,44031,44039)	~ "Ingenieria",
                       CODIGO_CARRERA	%in%	c(11020,11021,11022,11024,12013,13006,13007,13008,13009,13010,13011,13105,14001,16068,17000,17014,21015,22070,23046,25031,30070,33066,34002,34003,35029,35032,37011,37014,37085,39101,39116,39119,39412,41026) ~ "Agricultura",
                       CODIGO_CARRERA	%in%	c(11080,11081,11082,11084,11085,11086,11087,12018,12057,12060,12061,12062,13025,13050,13081,13082,13083,13087,13088,13103,13104,14008,14015,14082,16092,16093,17005,17015,17028,17032,17076,17086,17087,17825,18089,18090,18091,19031,19036,19041,19042,19043,19044,19046,19047,19048,19049,19091,20098,21043,22007,22026,22029,22051,22052,22055,22097,22102,22103,23026,23059,23060,23065,23068,24003,24011,24013,24017,24033,24065,24067,25033,25037,26071,26093,26094,27043,27080,29010,29052,29054,29055,29066,30020,30021,30022,30023,30029,30032,30035,30066,32002,32005,32027,32028,32029,32061,33023,33024,33035,33060,34022,34024,34025,34026,34027,35001,35002,35006,35007,35052,36021,36050,36051,36064,37004,37064,37065,37066,37067,37068,38172,38173,38323,38325,39109,39110,39117,39120,39121,39132,39133,39405,39406,39410,39413,39414,39420,39421,40071,40072,40073,41008,41009,41010,41017,41032,41057,41059,41066,41067,41070,41078,41096,41098,41102,41103,41105,41111,41125,41126,41159,43015,43016,43017,43024,44016,44017,44018,44020,44022,44032,44033,44034,44035,45004) ~ "Salud y trabajo social",
                       CODIGO_CARRERA	%in%	c(11078,11083,11095,12056,12058,13086,13091,16091,17013,17031,17089,18087,19039,19040,19050,24047,24048,25036,29068,30026,30033,34020,34023,35005,36020,38170,38171,39118,39122,39411,39415,40070,40080,41056,41060,41095,41099,41127,43001,43002,43014,43018,44019,44021,44036) ~ "Medicina",
                       CODIGO_CARRERA	%in%	c(11055,12021,13024,13029,14030,17082,18060,18083,19030,22021,22095,23016,24040,25070,30039,33025,34051,34052,36001,37040,38004,39107,39403,40030,41021,41071,41106,41133,42003,42023,43012,44006,44026,45009) ~ "Leyes",
                       CODIGO_CARRERA	%in%	c(11001,12004,13080,14002,15019,16070,17033,18040,19020,21047,23025,25015,29001,32001,33030,34060,38083,39103,39401,40001,41000,41061,44001,44024) ~ "Arquitectura",
                       CODIGO_CARRERA	%in%	c(11026,11040,11042,12014,13019,13022,13030,13078,13094,14005,14006,15020,15073,16034,16035,16036,16038,16080,16087,17003,17009,17054,17078,18046,18056,18084,19005,19027,19029,19051,19060,19062,19065,19068,19069,19086,19093,19095,21012,21048,21081,21082,22004,22005,22042,23013,23063,24046,24069,25061,25067,25069,26083,27035,27063,29045,29049,29059,29063,30000,30085,32011,32012,33009,33027,34018,34055,34056,34058,35053,35054,35056,36012,36016,37020,37055,37081,37084,38003,38006,39114,39115,39409,40040,40041,41023,41027,41028,41029,41030,41031,41072,41075,41076,41077,41107,41108,41109,41110,41123,41129,41136,42001,42021,43010,43019,44008,44009,44028,44038,45001) ~ "Administracion y Negocios",
                       CODIGO_CARRERA	%in%	c(13073,14064,14074,15008,15040,15051,15075,16004,16014,16046,17008,18057,18068,18092,19085,21030,21041,22069,22075,23048,25034,26067,26099,27004,27036,29027,29037,29057,30086,32003,32016,34007,35040,36031,37018,39112,39407,40062,41045,41048,41090) ~ "Ciencias Computacion",
                       CODIGO_CARRERA	%in%	c(11033,11035,11036,11037,11038,12031,12032,12054,12055,13001,13004,13015,13046,13049,13055,13056,14013,15028,15029,15041,15062,16039,16040,16042,16044,16079,17034,17821,18053,18054,18063,18064,19071,19078,19090,21083,22035,23047,24063,24080,25027,25028,25030,27009,36058,37069,39134,41011,41012,41013,41014,41043,41088,41118) ~ "Ciencias fisicas",
                       CODIGO_CARRERA	%in%	c(11028,11034,12051,13002,13065,14017,14075,16045,16047,16048,18074,19072,19077,24066,25020,26068,29018) ~ "Matematicas",
                       TRUE ~ NA_character_))

base_ingresos <- base_ingresos %>% select(1:5,44,everything()) %>% arrange(OECD_SUBAREA,FOS)

base_ingresos <- base_ingresos %>%
  mutate(FOS=case_when(CODIGO_CARRERA	%in%	c(		)	~ "Educacion"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Humanidades y Artes"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Ciencias sociales"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Ciencias de la vida"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Ingenieria"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Agricultura"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Salud y trabajo social"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Medicina"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Leyes"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Arquitectura"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Administracion y Negocios"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Ciencias Computacion"	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Ciencias fisicas",	,
                       CODIGO_CARRERA	%in%	c(		)	~ "Matematicas"	,
                       TRUE ~ NA_character_))


xlsx::write.xlsx(base_ingresos, file = "output/base_ingresos.xlsx")

data %>% filter(n!=1) %>% as.data.frame()
# Pase de datos matricula 2015
# Sacar datos agregados 





